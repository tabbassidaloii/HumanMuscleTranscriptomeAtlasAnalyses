---
title: "Human muscle transcriptomics (file 8)"
subtitle: 'WGCNA'
output:
  html_notebook: 
    toc: yes
    code_folding: hide
  word_document: default
editor_options:
  chunk_output_type: inline
  always_allow_html: true
---

```{r setup5, include = FALSE}
rm (list = ls ())
suppressPackageStartupMessages ({ 
  library (data.table)
  library (limma)
  library (edgeR)
  library (dplyr)
  library (WGCNA)
  library (biomaRt)
  library (flashClust)  
  library (ggplot2)
  library (scales) 
  library (dplyr)
  library (plotly)
  library (knitr)
  library (scales)
  library (cowplot)
  library (tidyr)
  library (grid)
  library (ggpubr)
  })
opts_chunk$set (eval = TRUE, echo = TRUE, tidy = TRUE, highlight = TRUE, dev = c ('png'), fig.width = 10, fig.height = 8,  fig.path = "figures/")

BiocStyle::markdown ()
options (scipen = 999)

# Loading the data
Data <- new.env(); load ("Outputs/BatchMusCorrectedAllData.RData", envir = Data )
D_BatchMus <- Data$D_BatchMus
v_BatchMus <- Data$v_BatchMus

# RNA isolation protocol
WithKit <- c ("MD06_GRA_Sam25", "MD07_GRA_Sam23", "MD08_GRA_Sam65", 
              "MD10_GRA_Sam106", "MD12_GRA_Sam139")
WithoutKit <- c ("MD06_GRA_Sam148", "MD07_GRA_Sam73_RedoSam15", "MD08_GRA_Sam152_RedoSam39", 
                 "MD10_GRA_Sam36", "MD12_GRA_Sam116")
# Color and pch
pch.muscle <- c ("GAL" = 1, "GRA" = 2, "REF" = 3, "SEM" = 4, "SED" = 5, "VAL" = 6, "VAM" = 7)
col.muscle <- c ("GAL" = "#800000", "GRA" = "#4363d8", "REF" = "#f032e6", 
                 "SED" = "#ffe119", "SEM" = "#3cb44b", "VAL" = "#e6beff", 
                 "VAM" = "#f58231")
col.batch <- c ("1" = "#e6194B", "2" = "#3cb44b", "3" = "#4363d8", "4" = "#911eb4", "5" = "black")
col.individual <- c ("MD06" = "#A6CEE3", "MD07" = "#1F78B4", "MD08" = "#B2DF8A", 
                     "MD10" = "#33A02C", "MD11" = "#FB9A99", "MD12" = "#E31A1C", 
                     "MD13" = "#FDBF6F", "MD14" = "#FF7F00", "MD15" = "#66C2A5", 
                     "MD16" = "#FC8D62", "MD17" = "#8DA0CB", "MD18" = "#E78AC3", 
                     "MD19" = "#A6D854", "MD20" = "#FFD92F", "MD21" = "#E5C494", 
                     "MD22" = "#B3B3B3", "MD26" = "#1B9E77", "MD27" = "#D95F02", 
                     "MD28" = "#7570B3", "MD31" = "#E7298A")
col.lane <- c ("L003.1" = "lightblue", "L004.1" = "darkblue", "L002.2" = "pink", "L004.2" = "red")
col.RNA <- c ("WithKit" = "#bfef45", "WithOutKit" = "#f58231")
col.Hos <- c ("EMC" = "green", "HMC" = "orange")

# Colors and labels for plots
MusLabPlot <- gsub ("MD[0-9][0-9]_|_Sam.*", "", colnames (D_BatchMus))
MusColPlot <- col.muscle [raster::match (gsub ("MD[0-9][0-9]_|_Sam.*", "", colnames (D_BatchMus)), 
                                  names (col.muscle))]
IndLabPlot <- gsub ("_.*", "", colnames (D_BatchMus))
IndColPlot <- col.individual [raster::match (gsub ("_.*", "", colnames (D_BatchMus)), 
                                  names (col.individual))]
BatchLabPlot <- D_BatchMus$samples$batch [raster::match (colnames (D_BatchMus), rownames (D_BatchMus$samples))]
BatchColPlot <- col.batch [match (D_BatchMus$samples$batch [match (colnames (D_BatchMus), 
                                                          rownames (D_BatchMus$samples))], 
                                names (col.batch))]
RNALabPlot <- D_BatchMus$samples$IsolationRNA [match (colnames (D_BatchMus), rownames (D_BatchMus$samples))]
RNAColPlot <- col.RNA [match (D_BatchMus$samples$IsolationRNA [match (colnames (D_BatchMus), 
                                                             rownames (D_BatchMus$samples))], 
                                names (col.RNA))]
LaneLabPlot <- D_BatchMus$samples$lane [match (colnames (D_BatchMus), rownames (D_BatchMus$samples))]
LaneColPlot <- col.lane [match (D_BatchMus$samples$lane [match (colnames (D_BatchMus), 
                                                       rownames (D_BatchMus$samples))], 
                                names (col.lane))]
HosLabPlot <- D_BatchMus$samples$Hospital [match (colnames (D_BatchMus), rownames (D_BatchMus$samples))]
HosColPlot <- col.Hos [match (D_BatchMus$samples$Hospital [match (colnames (D_BatchMus), 
                                                       rownames (D_BatchMus$samples))], 
                                names (col.Hos))]

```

## C. Gene coexpression network analysis
### Finding the outlier samples using Eucidian distance
```{r OutlierSample, message = FALSE, warning = FALSE, fig.width = 14}
# show that row names agree	
# all (rownames (v_BatchMus$targets) == colnames (v_BatchMus$E)) 	
# sample network based on squared Euclidean distance	
# note that data should be transposed 	
A <- WGCNA::adjacency (v_BatchMus$E, type = "distance", corFnc = WGCNA::cor)	
# this calculates the whole network connectivity	
k <- as.numeric (apply (A, 2, sum)) - 1	
# standardized connectivity	
Z.k <- scale (k)	
# Designate samples as outlying	
# if their Z.k value is below the threshold	
thresholdZ.k <- -2.5 # often -2.5	
# the color vector indicates outlyingness (red)	
outlierColor <- ifelse (Z.k < thresholdZ.k, "red", "black")	
# calculate the cluster tree using flahsClust or hclust	
sampleTree <- flashClust (as.dist (1 - A), method = "average")	
# Convert traits to a color representation where red indicates high values	
traitColors <- data.frame (Muscle = MusColPlot,
                           Individual = IndColPlot,
                           Hospital = HosColPlot,
                           RNAprotocol = RNAColPlot, 
                           Batch = BatchColPlot,
                           Lane = LaneColPlot)

traitColors <- cbind (traitColors, data.frame (numbers2colors (sapply (v_BatchMus$targets %>% dplyr::select ("lib.size", "RIN", "Concen.", "age"), as.numeric), signed = FALSE)))
dimnames (traitColors) [[2]][7:10] <- c ("LibSize", "RIN", "Concen.", "Age")
datColors <- data.frame (outlierC = outlierColor, traitColors)	
# Plot the sample dendrogram and the colors underneath. 	
plotDendroAndColors (sampleTree, dendroLabels = gsub ("_Sam.*", "",colnames (v_BatchMus$E)), groupLabels = names (datColors), colors = datColors, main = "Sample dendrogram and trait heatmap")
# Remove outlying samples from expression and phenotypic data	
```

In general the sample dendrogram (based on Euclidean distance) confirms our earlier observation, bigger inter-individual difference than the muscle differences!
REF MD13 and VAM MD28 are detected as outlier samples but I think we don't need to exclude these samples since the dataset is big and these two samples will not have big effect on the network construction since the `corOptions = c ("maxPOutliers = 0.1")` argument is also specified for the network construction.

In addition, these two samples are not that far away form other samples looking at the PCA plots.

### WGCNA in 5 steps
1. Calculating the dissimilarity matrix using 7 different powers (6, 8, 10, 12, 14, 18, 22)
2. Detecting module using 3 settings for minClusterSize (15, 20, 30) and 3 settings for different deepSplit (0, 2, 4) 
3. Merging modules using 5 settings for cutHeight (0.1, 0.15, 0.2, 0.25, 0.3)
4. Defining co-expressed pairs (CPs)
5. Defining knowledge pairs (KPs)
6. Finding the overlap between KPs and CPs
7. Creating settings summary file

```{r AllStepsWGCNA1, echo = FALSE, message = FALSE, warning = FALSE, fig.show = FALSE}
enableWGCNAThreads ()
## Choose a set of soft thresholding powers	
powers <- c (c (1 : 10), seq (12, 30, 2))	
# choose power based on SFT criterion	
# conflict_prefer("cor", "WGCNA")
# conflict_prefer("which.max", "raster")
# conflict_prefer("filter", "dplyr")
# conflict_prefer("paste", "base")
sft <- pickSoftThreshold (t (v_BatchMus$E), powerVector = powers, corFnc = bicor, 	
                           corOptions = c ("maxPOutliers = 0.1"), networkType = "signed hybrid")	
# Plot the results: 	
par (mar = c (5, 4, 4, 2) + 0.1, mfrow = c (1, 2))	
# SFT index as a function of different powers	
plot (sft$fitIndices [, 1 ], - sign (sft$fitIndices [, 3 ]) * sft$fitIndices [, 2 ] ,	
       xlab = "Soft Threshold (power)", ylab = "Scale Free Topology Model Fit, signed R^2", type = "n", 
       main = "Scale independence")	
text (sft$fitIndices [, 1 ], - sign (sft$fitIndices [, 3 ]) * sft$fitIndices [, 2 ] ,	
labels = powers, col = "red")	
# R^2 cut-off	
abline (h = 0.9, col = "blue")	
# Mean connectivity as a function of different powers	
plot (sft$fitIndices [, 1 ], sft$fitIndices [, 5 ], type = "n", 	
       xlab = "Soft Threshold (power)", ylab = "Mean Connectivity", main = "Mean connectivity")
text (sft$fitIndices [, 1 ], sft$fitIndices [, 5 ], labels = powers, col = "red")	
```

The Powers that we selected for the network construction all have R2 above 0.8

```{r AllStepsWGCNA2, echo = FALSE, message = FALSE, warning = FALSE, fig.show = FALSE}
# 1. Adjacency and dissTOM
if (length (list.files ("Outputs/WGCNA/dissTOM")) == 0) {
  # Create correlation matrix
  A <- adjacency (t (v_BatchMus$E), power = 1, type = "signed hybrid", corFnc = "bicor", corOptions = c ("maxPOutliers = 0.1"))
  # change the default power value in adjacency function (WGCNA) to 1
  adjacencyPower <- function (cor_mat, power) {abs (cor_mat) ^ power}
  # Weighted adjacency matrix, using different powers:
  power <- c (6, 8, 10, 12, 14, 18, 22)
  # Parallel computing considering different powers

  for (i in 1: length(power)) {
      # Raised adjacency matrix to different powers 
      Adjacency <- adjacencyPower (A, power = power [ i ])
      save (Adjacency, file = paste0 ("Outputs/WGCNA/Adjacency/AdjacencyPower", power [ i ], ".RData"))
      # Define a dissimilarity based on the topological overlap
      TOM <- WGCNA :: TOMsimilarity (Adjacency, TOMType = "signed")
      colnames (TOM) <- rownames (TOM) <- colnames (Adjacency)
      dissTOM <- 1 - TOM
      # Hierarchical gene clustering (according to the dissimilarity matrix)
      geneTree <- flashClust :: flashClust (as.dist (dissTOM), method = "average")
      save (dissTOM, geneTree, file = paste0 ("Outputs/WGCNA/dissTOM/dissTOMPower", power [ i ], ".RData"))
      rm (Adjacency, TOM, dissTOM, geneTree)
  }
}

# 2. Module Detection
if (length (list.files ("Outputs/WGCNA/ModuleDetection/")) == 0) {
  filenames <- list.files ("Outputs/WGCNA/dissTOM/", full.names = T)
  for (file in filenames){
    args <-  c(9, file, 3, 15, 20, 30, 3, 0, 2, 4)
    # loading dissimilarity matrix
    power <- gsub ("[^[:digit:], ]", "", args [ 2 ])
    load (args [ 2 ]) 
    # Module detection
    # Set the minimum module size 
    args <- as.numeric (args [ -2 ])
    minModuleSize <- args [ 3 : (args [ 2 ] + 2) ]
    deepSplit <- args [ 7:(args [ 6 ] + 6) ]
    Combin <- expand.grid (minModuleSize, deepSplit)
    print (Combin)
    for (i in 1: nrow (Combin)) {
      # Module detection by cutting branches
      dynamicMods <- dynamicTreeCut :: cutreeDynamic (dendro = geneTree, distM = dissTOM, method = "hybrid", 
                                                      deepSplit = Combin [ i, 2 ], pamRespectsDendro = FALSE,
                                                      minClusterSize = Combin [ i, 1 ])
      # Convert labels to colors for plotting
      dynamicColors <- WGCNA :: labels2colors (dynamicMods)
      # Calculate eigengenes (clustring modules based on expression similarities)
      MEList <- WGCNA :: moduleEigengenes (t (v_BatchMus$E), colors = dynamicColors)
      MEs <- MEList$eigengenes
      NAMES <- colnames (dissTOM)
      save (dynamicColors, geneTree, NAMES, file = paste0 ("Outputs/WGCNA/ModuleDetection/ModuleDetectionPower", power,
                                                           "MinModuleSize", Combin [ i, 1 ],
                                                           "deepSplit", Combin [ i, 2 ], ".RData"))
    }
  }
}

# 3. Merge Modules
if (length (list.files (recursive = TRUE, pattern = "All_genes_modules_Power", path = "Outputs/WGCNA/MergeModules/")) == 0){
  
  filenames <- list.files ("Outputs/WGCNA/ModuleDetection/", full.names = T)
  SAVEPATH <- "Outputs/WGCNA/MergeModules/"
  for (file in filenames){
    args <-  c(file, 5, 0.1, 0.15, 0.20, 0.25, 0.30)
    Setting <- gsub (".*ModuleDetection|.RData", "", args [ 1 ])
    print (Setting)
    # loading Modules
    load (args [ 1 ])
    # Merging similar modules
    args <- as.numeric (args [ -1 ])
    CutHeight <- args [ 2 : (args [ 1 ] + 1) ]
    for (i in 1: length (CutHeight)) { 
      # Call an automatic merging function
      merge <- WGCNA :: mergeCloseModules (t(v_BatchMus$E), dynamicColors, cutHeight = CutHeight [ i ],
                                           verbose = 3, corFnc = bicor) 
      # The merged module colors
      mergedColors <- merge$colors
      # Eigengenes of the new merged modules:
      mergedMEs <- merge$newMEs
      write.csv (mergedMEs, paste0 (SAVEPATH, "ModuleEigengenes_merged_", 
                                    Setting, "CutHeight", CutHeight [ i ], ".csv"), row.names = FALSE)
      # Summary output of network analysis results (after merging)
      module_colors <- unique (mergedColors)
      All_genes_modules <- as.data.frame (cbind (NAMES, mergedColors)) 
      # colnames (All_genes_modules) <- NULL
      write.csv (All_genes_modules, paste0 (SAVEPATH, "All_genes_modules_", Setting,
                                            "CutHeight", CutHeight [ i ], ".csv"), row.names = FALSE)
      # names (colors) of the modules
      nSamples <- nrow (t(v_BatchMus$E))
      modNames <- substring (names (mergedMEs), 3)
      geneModuleMembership <- as.data.frame (bicor (t(v_BatchMus$E), mergedMEs, maxPOutliers = 0.1)) 
      MMPvalue <- as.data.frame (corPvalueStudent (as.matrix (geneModuleMembership), nSamples)) 
      names (geneModuleMembership) <- gsub ("ME", "MM", names (geneModuleMembership))
      names (MMPvalue) <-  gsub ("ME", "p.MM", names (MMPvalue))
      write.csv (merge (geneModuleMembership, MMPvalue, by=0, all = TRUE, sort = FALSE),
                 paste0 (SAVEPATH, "GeneModule_Membership_MMPvalue_", Setting,
                         "CutHeight", CutHeight [ i ], ".csv"), col.names = TRUE, row.names = FALSE)
      phenWGCNA <- v_BatchMus$targets %>%
        mutate (group = as.numeric(group)) %>%
        mutate (individual = as.numeric(gsub ("MD", "", individual))) %>%
        select (-"sampleID") %>%
        mutate (IsolationRNA = ifelse (IsolationRNA == "WithOutKit", 1, 0)) %>%
        mutate (Hospital = ifelse (Hospital == "HMC", 1, 0)) %>%
        mutate (lane = as.numeric (lane)) %>%
        mutate (batch = as.numeric (batch))
    
    
      # Module membership values and gene significance
      for (j in 1 : length (phenWGCNA) [ 1 ]) 
        {
        # Define interested variable of datTrait
        traitOfInterest <- as.data.frame (phenWGCNA [, j ])
        names (traitOfInterest) <-  colnames (phenWGCNA) [ j ]
        ## Relating modules to external clinical traits and identifying important genes
        nGenes <- ncol (t (v_BatchMus$E))
        nSamples <- nrow (t (v_BatchMus$E))
        moduleTraitCor <- matrix (nrow = dim (mergedMEs) [ 2 ], ncol = dim (phenWGCNA) [ 2 ]) 
        colnames (moduleTraitCor) <- paste0 ("Cor_", colnames (phenWGCNA))
        rownames (moduleTraitCor) <- colnames (mergedMEs) 
        for (trait in colnames(phenWGCNA)) {
          moduleTraitCor [, grep (trait, colnames (moduleTraitCor)) ] <-
            cor (mergedMEs, phenWGCNA [, trait ], use = "pairwise.complete.obs")
        }
        moduleTraitPvalue <- corPvalueStudent (moduleTraitCor, nSamples)
        colnames (moduleTraitPvalue) <- paste0 ("Pvalue_", colnames (moduleTraitPvalue))
    
        # Writing the tables down with modules and correlation
        write.csv (merge (moduleTraitCor, moduleTraitPvalue, by = 0, all = TRUE, sort = FALSE),
                   paste0 (SAVEPATH, "ModuleTrait_Cor_Pvalue_", Setting, "CutHeight",  CutHeight [ i ], ".csv"), 
                   col.names = TRUE, row.names = FALSE) 
    
    
        # correlation matrix of each gene and each traits
        geneTraitSignificance <- as.data.frame (cor (t (v_BatchMus$E), traitOfInterest,
                                                use = 'pairwise.complete.obs'))
        GSPvalue <- as.data.frame (corPvalueStudent (as.matrix (geneTraitSignificance), nSamples)) 
        names (geneTraitSignificance) <- paste0 ("GS.", names (traitOfInterest))
        names (GSPvalue) <- paste0 ("p.GS.", names (traitOfInterest))
        write.csv (merge (geneTraitSignificance,  GSPvalue, by=0, all = TRUE, sort = FALSE), 
                   paste0 (SAVEPATH, colnames (phenWGCNA)[ j ],"_GeneTrait_Significance_GSPvalue_",
                           Setting, "CutHeight",  CutHeight [ i ],
                           ".csv"), col.names = TRUE, row.names = FALSE)
      }
    }
  }
}

# 4. Coexpressed Pairs 
if (! file.exists ("Outputs/WGCNA/CoexpressedPairs/Power10MinModuleSize15deepSplit0CutHeight0.1.RData")) {
  filenames <- list.files (recursive = TRUE, pattern = "All_genes_modules_Power", 
                            path = "Outputs/WGCNA/MergeModules/", full.names = TRUE)	
  SAVEPATH <- "Outputs/WGCNA/CoexpressedPairs/"
  for (file in filenames){
    args = file
    Genes_Modules <- read.csv (args [ 1 ])
    # remove genes which were not clustered (grey module)
    Genes_Modules <- Genes_Modules [ Genes_Modules$mergedColors != "grey", ]
    Modules <- unique (Genes_Modules$mergedColors)
    All_pairs <- c ()
    for (module in 1 : length (Modules)) { 
      subset <- Genes_Modules [ Genes_Modules$mergedColors == Modules [ module ], ]
      # subset$NAMES <- gsub ("\\..*", "", subset$NAMES)
      Genes <- as.character (sort (subset$NAMES))
      Pairs <- as.data.frame (t (combn (Genes, 2,)))
      # Pairs$module <- Modules [ module ] 
      All_pairs [[ module ]] <- Pairs
      }
    All_pairs <- as.data.frame (do.call (rbind, All_pairs))
    print (head (All_pairs))
    print (dim (All_pairs))
    # All_pairs$module <- NULL
    save (All_pairs, file = paste0 (SAVEPATH,
                                    gsub (".*All_genes_modules_|.csv", "", args [ 1 ]), ".RData"))
  }
}

# 5. Reactome knowledge pairs
if (! file.exists ("Outputs/WGCNA/KnowledgeNetwork/Reactome_KnowledgePairs.RData")) {
  Gene_list <- unique (rownames (v_BatchMus))

  # Annotating gene ids using gProfileR
  GenePathway_all <- c ()
  for (i in seq (0, length (Gene_list), 100)) {
    print (i)
    GS <- as.vector (na.omit (Gene_list [ (i + 1) : (i + 100) ]))
    BG <- unique (as.vector (Gene_list))
    print (length (GS))
    GP <- gProfileR::gprofiler (as.vector (GS), organism = 'hsapiens', significant = F,
                                domain_size = "known", custom_bg = BG, correction_method = "fdr", src_filter = "REAC")
    if (dim (GP) [ 1 ] != 0) { GP$query.number <- i }
    if (i == 0) GenePathway_all <- GP else GenePathway_all <- rbind (GenePathway_all, GP)
  }
  save (GenePathway_all, file = "Outputs/WGCNA/KnowledgeNetwork/GenePathway.RData")

  load ("Outputs/WGCNA/KnowledgeNetwork/GenePathway.RData")
  GenePathway_all [, c (1 : 3, 5, 7, 8, 11, 13) ] <- NULL

  GenePathway_all <- aggregate (GenePathway_all [ - c (1, 3, 4, 5) ], by = list (GenePathway_all$term.size,
                                                                                 GenePathway_all$term.id,
                                                                                 GenePathway_all$ domain,
                                                                                 GenePathway_all$term.name),
                                c)
  colnames (GenePathway_all) [ 1 : 4 ] <- c ("term.size", "term.id", "domain", "term.name")
  x <- GenePathway_all$overlap.size
  y <- character (length (x))
  for (i in 1 : length (x)) y [ i ] <- as.numeric (sum (x [[ i ]]))
  GenePathway_all$overlap.size <- as.numeric (y)
  x <- GenePathway_all$intersection
  y <- character (length (x)) 
  for (i in 1 : length (x)) y [ i ] <- paste0 (unique (x [[ i ]]), collapse = ",")
  GenePathway_all$intersection <- y

  # Extracting the annotations from Reactome and HPO
  GenePathway_REAC <- GenePathway_all [ grep ("REAC:", GenePathway_all$term.id), ]
  # Removing generic terms
  GenePathway_REAC <- GenePathway_REAC [ ! GenePathway_REAC$term.name == "Reactome", ]

  rm (list = setdiff (ls (), c ("GenePathway_REAC")))

  # Knowledge pairs based on Reactome and HP
  Pathways <- unique (GenePathway_REAC$term.id)
  All_pairs <- c ()
  for (i in 1 : length (Pathways)) {
    genes <- sort (unlist (strsplit (GenePathway_REAC [ GenePathway_REAC$term.id == Pathways [ i ], "intersection" ], split = ",")))
    if (length (genes) != 1)
      { Pairs <- as.data.frame (t (combn (sort (genes), 2)))
      if (length (All_pairs) == 0) All_pairs <- Pairs else All_pairs <- rbind (All_pairs, Pairs)
    }
  }
  All_Knowledge_pairs <- unique (All_pairs)
  Annotated_genes <- unique (unlist (strsplit (GenePathway_REAC$intersection, split = ","))) 

  save (All_Knowledge_pairs, Annotated_genes, GenePathway_REAC, file = "Outputs/WGCNA/KnowledgeNetwork/Reactome_KnowledgePairs.RData")
}

# 6. Overlap
if (! file.exists ("Outputs/WGCNA/OverlabCP_KP/OverlapCP_KP.RData")) {
  rm (list = ls())
  load ("Outputs/WGCNA/KnowledgeNetwork/Reactome_KnowledgePairs.RData")
  All_Knowledge_pairs <- sapply (All_Knowledge_pairs, as.character)
  filenames <- list.files (recursive = TRUE, path = "Outputs/WGCNA/CoexpressedPairs", full.names = TRUE)	

  # length (Annotated_genes) ## No. of genes with Reatome annotation in GSE36398 dataset
  Overlap_all <- c()
  for (file in filenames){
    load (file)
    Coexpressed_pairs <- sapply (All_pairs, as.character) ; rm (All_pairs)
    Annotated_Coexpressed_pairs <- unique (Coexpressed_pairs [ Coexpressed_pairs [,"V1"] %in% 
                                                                 Annotated_genes &
                                                                 Coexpressed_pairs [,"V2"] %in%
                                                                 Annotated_genes, ])
    Annotated_Coexpressed_genes <- unique (c (Annotated_Coexpressed_pairs [,"V1"],
                                              Annotated_Coexpressed_pairs [,"V2"]))
    N <- length (Annotated_Coexpressed_genes) ## Co-expressed and annotated genes
    All_possible_pairs <- (length (Annotated_genes) * (length (Annotated_genes) - 1)) / 2 

    # Annotated_Coexpressed_pairs <- apply (Annotated_Coexpressed_pairs[, c ("V1", "V2") ], 1, FUN = function (x) paste(sort(x), collapse = "-"))
    Pairs <- merge (Annotated_Coexpressed_pairs, All_Knowledge_pairs)
    print (dim (Pairs))
    Annotated_Coexpressed_pairs <- Annotated_Coexpressed_pairs [, c (2, 1) ]
    colnames (Annotated_Coexpressed_pairs) <- colnames (All_Knowledge_pairs)
    Pairs1 <- merge (Annotated_Coexpressed_pairs, All_Knowledge_pairs)
    print (dim (Pairs1))
    Pairs <- unique(rbind (Pairs, Pairs1))
    print (dim (Pairs))
    SM_SP <- dim (Pairs) [ 1 ]
    SM_nSP <- dim (Annotated_Coexpressed_pairs) [ 1 ] - SM_SP
    nSM_SP <- dim (All_Knowledge_pairs) [ 1 ] - SM_SP
    nSM_nSP <- All_possible_pairs - (SM_SP + SM_nSP + nSM_SP)
    table2_2 <- rbind (c (SM_SP, nSM_SP), c (SM_nSP, nSM_nSP))
    Ftest <- fisher.test (table2_2)
    OutPut <- data.frame (setting = gsub (".*\\/|.RData", "", file),
                          No_Annotated_Coexpressed_genes = length (Annotated_Coexpressed_genes),
                          Ftest = Ftest$p.value, odds_ratio = Ftest$estimate,
                          SM_SP = SM_SP, SM_nSP = SM_nSP, nSM_SP = nSM_SP, nSM_nSP = nSM_nSP)
    rownames(OutPut) <- NULL
    print (OutPut)
    Overlap_all [[gsub (".*\\/|.RData", "", file)]] <- OutPut
  }
  Overlap_all <- data.table::rbindlist (Overlap_all)
  save (Overlap_all, file = "Outputs/WGCNA/OverlabCP_KP/OverlapCP_KP.RData")
}

# 7. Settings summary
if (! file.exists ("Outputs/WGCNA/OverlabCP_KP/SettingsSummary.RData")) {
  rm (list = ls())
  load ("Outputs/WGCNA/OverlabCP_KP/OverlapCP_KP.RData")
  # head (Overlap_all)
  filenames <- list.files (recursive = TRUE, path = "Outputs/WGCNA/MergeModules/", pattern = "All_genes_modules", full.names = TRUE)
  SettingsSummary <- matrix (NA, nrow = length (filenames), ncol = 8)
  rownames (SettingsSummary) <- gsub (".*All_genes_modules_|.csv", "", filenames)
  for (file in filenames) {
    x <- read.csv (file)
    setting <- gsub (".*All_genes_modules_|.csv", "", file)
    SettingsSummary [ setting, ] <- c (length (unique (x [ x$mergedColors == "grey", 1 ])), 
                                       length (table (x$mergedColors)) - 1,
                                       summary (as.vector (table (x [x$mergedColors != "grey", ]$mergedColors))))
    }
  colnames (SettingsSummary) <- c ("GreyM.size", "NoModules", "MinM.Size", "1stQ", "MedianM.Size",
                                   "MeanM.Size", "3stQ", "MaxM.Size")
  # The final setting table
  Setting <- merge (Overlap_all, as.data.frame (SettingsSummary) %>% 
                      tibble::rownames_to_column(var = "setting"), by = "setting")
  save (Setting, file = "Outputs/WGCNA/OverlabCP_KP/SettingsSummary.RData") } else {
    rm (list = prob::setdiff (ls (), c ("v_BatchMus", "Data")))
    load ("Outputs/WGCNA/OverlabCP_KP/SettingsSummary.RData")
  }
```

### Selecting the best WGCNA setting
```{r SelectingBestSetting, echo = FALSE, message = FALSE, warning = FALSE, fig.show = FALSE}
Setting <- Setting %>% 
  mutate (Power = as.numeric (gsub ("Power|MinModuleSize.*", "", setting))) %>%
  mutate (MinModuleSize =  gsub (".*MinModuleSize|deepSplit.*", "", setting)) %>%
  mutate (deepSplit =  gsub (".*deepSplit|CutHeight.*", "", setting)) %>%
  mutate (CutHeight =  gsub (".*CutHeight", "", setting)) %>%
  arrange (Power)
# head(Setting, 1)

p1 <- ggplot (Setting) +
  stat_summary (mapping = aes (x = reorder (Power, setting), y = odds_ratio),
                geom = "point", fun = "median") +
  labs (x = "Power", y = "Reactome's enrichment factor") +
  theme_bw () +
  theme (axis.text = element_text (size = 10, colour = "black"),
         axis.title = element_text (size= 10, face = "bold"), panel.grid = element_blank())

p2 <- ggplot (Setting) +
  stat_summary (mapping = aes (x = MinModuleSize, y = odds_ratio),
                geom = "point", fun = "median") +
  labs (x = "minClusterSize") +
  theme_bw () +
  theme (axis.text = element_text (size = 10, colour = "black"),
         axis.title = element_text (size= 10, face = "bold"), 
         axis.title.y = element_blank (), panel.grid = element_blank())

p3 <- ggplot (Setting) +
  stat_summary (mapping = aes (x = deepSplit, y = odds_ratio),
                geom = "point", fun = "median") +
  labs (x = "deepSplit") +
  theme_bw () +
  theme (axis.text = element_text (size = 10, colour = "black"),
         axis.title = element_text (size= 10, face = "bold"), 
         axis.title.y = element_blank (), panel.grid = element_blank())

p4 <- ggplot (Setting) +
  stat_summary (mapping = aes (x = CutHeight, y = odds_ratio),
                geom = "point", fun = "median") +
  labs (x = "cutHeight") +
  theme_bw () +
  theme (axis.text = element_text (size = 10, colour = "black"),
         axis.title = element_text (size= 10, face = "bold"), 
         axis.title.y = element_blank (), panel.grid = element_blank())

grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3),  
                    ggplotGrob (p4),                 
                    size = "first")) 
rm (list = paste0 ("p", 1:4))
ggplot (Setting, aes (x = NoModules, y = odds_ratio)) +
  geom_point (size = 2, alpha = 0.5) +
  stat_smooth (method = "lm", col = "red") +
  theme_bw () +
  labs (x = "Number of modules", y = "Reactome's enrichment factor") +
  theme (axis.text = element_text (size = 10, colour = "black"),
          axis.title = element_text (size= 10, face = "bold"), 
          title = element_text (size= 10, colour = "black"), panel.grid = element_blank())

# Selecting the best setting considering the grey module size
# < %30 in grey module
print ("< %30 in grey module")
SettingSubset0.3 <- Setting [ Setting$GreyM.size / nrow (v_BatchMus) < 0.3, ]
# Selected setting
print (SettingSubset0.3 [ which.max(SettingSubset0.3$odds), ])

ggplot (SettingSubset0.3, aes (x = NoModules, y = odds_ratio)) +
  geom_point (size = 2, alpha = 0.5) +
  stat_smooth (method = "lm", col = "red") +
  theme_bw () +
  labs (x = "Number of modules", y = "Reactome's enrichment factor") +
  theme (axis.text = element_text (size = 10, colour = "black"),
          axis.title = element_text (size= 10, face = "bold"), 
          title = element_text (size= 10, colour = "black"), panel.grid = element_blank())


# < %50 in grey module
print ("< %50 in grey module")
SettingSubset0.5 <- Setting [ Setting$GreyM.size / nrow (v_BatchMus) < 0.5, ]
# Selected setting
print (SettingSubset0.5 [ which.max(SettingSubset0.5$odds), ])

ggplot (SettingSubset0.5, aes (x = NoModules, y = odds_ratio)) +
  geom_point (size = 2, alpha = 0.5) +
  stat_smooth (method = "lm", col = "red") +
  theme_bw () +
  labs (x = "Number of modules", y = "Reactome's enrichment factor") +
  theme (axis.text = element_text (size = 10, colour = "black"),
          axis.title = element_text (size= 10, face = "bold"), 
          title = element_text (size= 10, colour = "black"), panel.grid = element_blank())

Candidate <- as.character (SettingSubset0.3 [ which.max(SettingSubset0.3$odds), "setting"])
rm (list = ls (pattern = "Setting"))
```

```{r ColSetup, include = FALSE}
# RNA isolation protocol
WithKit <- c ("MD06_GRA_Sam25", "MD07_GRA_Sam23", "MD08_GRA_Sam65", 
              "MD10_GRA_Sam106", "MD12_GRA_Sam139")
WithoutKit <- c ("MD06_GRA_Sam148", "MD07_GRA_Sam73_RedoSam15", "MD08_GRA_Sam152_RedoSam39", 
                 "MD10_GRA_Sam36", "MD12_GRA_Sam116")
# Color and pch
pch.muscle <- c ("GAL" = 1, "GRA" = 2, "REF" = 3, "SEM" = 4, "SED" = 5, "VAL" = 6, "VAM" = 7)
col.muscle <- c ("GAL" = "#800000", "GRA" = "#4363d8", "REF" = "#f032e6", 
                 "SED" = "#ffe119", "SEM" = "#3cb44b", "VAL" = "#e6beff", 
                 "VAM" = "#f58231")
col.batch <- c ("1" = "#e6194B", "2" = "#3cb44b", "3" = "#4363d8", "4" = "#911eb4", "5" = "black")
col.individual <- c ("MD06" = "#A6CEE3", "MD07" = "#1F78B4", "MD08" = "#B2DF8A", 
                     "MD10" = "#33A02C", "MD11" = "#FB9A99", "MD12" = "#E31A1C", 
                     "MD13" = "#FDBF6F", "MD14" = "#FF7F00", "MD15" = "#66C2A5", 
                     "MD16" = "#FC8D62", "MD17" = "#8DA0CB", "MD18" = "#E78AC3", 
                     "MD19" = "#A6D854", "MD20" = "#FFD92F", "MD21" = "#E5C494", 
                     "MD22" = "#B3B3B3", "MD26" = "#1B9E77", "MD27" = "#D95F02", 
                     "MD28" = "#7570B3", "MD31" = "#E7298A")
col.lane <- c ("L003.1" = "lightblue", "L004.1" = "darkblue", "L002.2" = "pink", "L004.2" = "red")
col.RNA <- c ("WithKit" = "#bfef45", "WithOutKit" = "#f58231")
col.Hos <- c ("EMC" = "green", "HMC" = "orange")

# Colors and labels for plots
MusLabPlot <- gsub ("MD[0-9][0-9]_|_Sam.*", "", colnames (v_BatchMus))
MusColPlot <- col.muscle [match (gsub ("MD[0-9][0-9]_|_Sam.*", "", colnames (v_BatchMus)), 
                                  names (col.muscle))]
IndLabPlot <- gsub ("_.*", "", colnames (v_BatchMus))
IndColPlot <- col.individual [match (gsub ("_.*", "", colnames (v_BatchMus)), 
                                  names (col.individual))]
BatchLabPlot <- v_BatchMus$samples$batch [match (colnames (v_BatchMus), rownames (v_BatchMus$samples))]
BatchColPlot <- col.batch [match (v_BatchMus$samples$batch [match (colnames (v_BatchMus), 
                                                          rownames (v_BatchMus$samples))], 
                                names (col.batch))]
RNALabPlot <- v_BatchMus$samples$IsolationRNA [match (colnames (v_BatchMus), rownames (v_BatchMus$samples))]
RNAColPlot <- col.RNA [match (v_BatchMus$samples$IsolationRNA [match (colnames (v_BatchMus), 
                                                             rownames (v_BatchMus$samples))], 
                                names (col.RNA))]
LaneLabPlot <- v_BatchMus$samples$lane [match (colnames (v_BatchMus), rownames (v_BatchMus$samples))]
LaneColPlot <- col.lane [match (v_BatchMus$samples$lane [match (colnames (v_BatchMus), 
                                                       rownames (v_BatchMus$samples))], 
                                names (col.lane))]
HosLabPlot <- v_BatchMus$samples$Hospital [match (colnames (v_BatchMus), rownames (v_BatchMus$samples))]
HosColPlot <- col.Hos [match (v_BatchMus$samples$Hospital [match (colnames (v_BatchMus), 
                                                       rownames (v_BatchMus$samples))], 
                                names (col.Hos))]
```

### Enrichment for celltype markers in modules
```{r MarkersInModules, echo = FALSE, message = FALSE, warning = FALSE, fig.show = FALSE, fig.height = 7, fig.width = 14}
filenames <- list.files (recursive = TRUE, path = "Outputs/WGCNA", pattern = paste0 (Candidate, ".csv"), full.names = TRUE)

# Importing gene-modules table
GeneModules <- read.csv (filenames [grepl ("All_genes_modules", filenames)]) %>%
  mutate (hgnc_symbol = v_BatchMus$genes$hgnc_symbol [match (NAMES, v_BatchMus$genes$ensembl_gene_id)])

# Rename modules (colors to numbers)
Module_rename <- data.frame (Module = prob::setdiff (sort (unique (GeneModules$mergedColors)), "grey"), 
                             Rename = paste ("M", seq.int (length (unique(GeneModules$mergedColors))-1), sep = "."), stringsAsFactors = FALSE) 

GeneModules$mergedColors <- Module_rename$Rename [ match (GeneModules$mergedColors, Module_rename$Module) ] 
GeneModules$mergedColors [is.na (GeneModules$mergedColors)] = "grey"

# Importing marker list
markers <- readxl::read_excel ("2020.Markers.Rubenstein.xlsx", skip = 1)
Fibermarkers <- readxl::read_excel ("2020.FiberMarkers.Rubenstein.xlsx", skip = 1)[1:40, c (2, 1)]

# Myofiber genes Based on Smith et al, 2013
fast <- data.frame (`Cell-type` = "Fast twitch", Genes = unique (c ("MYH1", "MYH2", "MYL1", "MYBPS2", "TNNT3", "TNNI2", "TNNC2", "TPM1", "TMOD4", "ATP2A1", "CASQ1", Fibermarkers$Gene [Fibermarkers$Muscle.Fiber.Type == "Type IIa"])))
slow <- data.frame (`Cell-type` = "Slow twitch", Genes = unique (c ("MYH7", "MYL2", "MYL3", "MYBL2", "TNNT1", "TNNI1", "TNNC1", "TPM3", "TMOD1", "ATP2A2", "CASQ2", Fibermarkers$Gene [Fibermarkers$Muscle.Fiber.Type == "Type I"])))

# Tendon markers (Kendal, et al., 2019, bioRxiv AND Orfei, et al., 2019)
Tendon <- data.frame (`Cell-type` = "Tendon", Genes = c ("COL1A1", "COL1A2", "SCX", "FBN1", "MFAP5", "VCAN", "EMILIN1", "TGFB1", "LTBP1", "LTBP2", "COL3A1", "GSN", "LUM", "DCN", "LY6E", "PDGFRA", "CXCL14", "TAGLN", "MYL9", "ACTA2", "RGS5", "ITGA7", "COL4A1", "PTX3", "POSTN", "DCN", "MKX", "TNC"))

# Yotam's muscle structural genes
# SarcomereGenes <- data.frame (`Cell-type` = "Sarcomere", Genes = read.csv ("Yotam_Gene_list.csv", sep = "\t")[, 1])

markers <- rbindlist (list (markers, fast, slow, Tendon))
CellTypes <- unique (markers$`Cell-type`)

# Markers distribution in the modules
CellMarkersInModules <- data.frame (table (GeneModules$mergedColors)) %>% mutate (Var1 = as.character (Var1))
colnames (CellMarkersInModules) <- c ("Module", "Size")

for (cell in CellTypes){
  # cell markers
  GeneMarkers <- markers$Gene [markers$`Cell-type`== cell]
  
  # Modules in which the cell markers are 
  NoMarkers <- as.data.frame (table (GeneModules %>% filter (hgnc_symbol %in% GeneMarkers) %>% .$mergedColors))
  colnames (NoMarkers) <- c ("Module", gsub (" ", "", cell))
  
  CellMarkersInModules <- merge (CellMarkersInModules, NoMarkers, all = T)
}
CellMarkersInModules [is.na (CellMarkersInModules)] = 0

CellMarkersInModulesPlot <- CellMarkersInModules %>% 
  mutate (Module = paste0 (Module, " (", Size, " genes)")) %>% 
  reshape2::melt (-c (1, 2), id.var = "Module")

CellMarkersInModulesPlot <- CellMarkersInModulesPlot [order (as.numeric (gsub ("M.| .*", "", CellMarkersInModulesPlot$Module))), ] %>% mutate (Module = factor (Module, levels = unique (Module)))
ggplot (CellMarkersInModulesPlot, aes (x = Module, y = variable)) + 
  geom_tile (aes (fill = value)) + 
  scale_fill_gradientn (colours = c ("white", "red"),
                        values = scales::rescale (c (0, 15, 31))) +
  geom_text (aes (label = value)) +
  ggtitle ("Loading of cell type markers in modules")  +
  labs (x = NULL, y = NULL, fill = "No. Genes") +
  theme (axis.text = element_text (size = 16),
         axis.text.x = element_text (angle = 90, hjust =  1, vjust = 0.5),
         axis.title = element_text (size= 16, face = "bold"))

# Calculating enrichment p-value
CellMarkersInModules [ nrow (CellMarkersInModules) + 1, -1 ] = colSums (CellMarkersInModules [-1])
CellMarkersInModules [is.na (CellMarkersInModules)] = "AllModules"
CellMarkersInModulesPvalue <- CellMarkersInModules 
for (i in 1:(nrow(CellMarkersInModules)-1)) {
  for (j in 3:ncol (CellMarkersInModules)) {
    data <- CellMarkersInModules [c (i,33), c (2,j)]
    pval <- unlist (fisher.test (data, alternative = "less")["p.value"])
    CellMarkersInModulesPvalue [i, j] <- pval  
  }
}

CellMarkersInModulesPvaluePlot <- CellMarkersInModulesPvalue [ -33, ] %>% 
  mutate (Module = paste0 (Module, " (", Size, " genes)")) %>% 
  reshape2::melt (-c (1, 2), id.var = "Module") %>% 
  mutate (value = round (value, digits = 2))
CellMarkersInModulesPvaluePlot <- CellMarkersInModulesPvaluePlot [order (as.numeric (gsub ("M.| .*", "", CellMarkersInModulesPvaluePlot$Module))), ] %>% mutate (Module = factor (Module, levels = unique (Module)))

ggplot (CellMarkersInModulesPvaluePlot, aes (x = Module, y = variable)) + 
  geom_tile (aes (fill = value)) + 
  scale_fill_gradientn (colours = c ("white", "red", "black"),
                        values = scales::rescale (c (0, 0.05, 0.1, 0.5, 1))) +
  geom_text (aes (label = value), size = 2) +
  ggtitle ("Loading of cell type markers in modules (pvalue)")  +
  labs (x = NULL, y = NULL, fill = "pvalue") +
  theme (axis.text = element_text (size = 16),
         axis.text.x = element_text (angle = 90, hjust =  1, vjust = 0.5),
         axis.title = element_text (size= 16, face = "bold"), )

# Cell type markers PC1 association with ME
# Module eigengene (ME) vector
mergedMEs <- read.csv (filenames [grepl ("ModuleEigengenes", filenames)]) 
rownames (mergedMEs) <- colnames (v_BatchMus)
colnames (mergedMEs)[colnames (mergedMEs) != "MEgrey"] <- Module_rename$Rename [ match (gsub ("ME", "", colnames (mergedMEs)[colnames (mergedMEs) != "MEgrey"]), Module_rename$Module) ] 
colnames (mergedMEs)[colnames (mergedMEs) == "MEgrey"] = "grey"

load ("Outputs/CellTypeComposition/CellTypesGeneMarkersPC1.RData")
load ("Outputs/CellTypeComposition/CellTypesGeneMarkersEigengene.RData")

CorFun <- function (data1, data2){
  if (all (rownames (data1) != rownames (data2))) print ("Check the input rownames")
  COR <- matrix (NA, ncol (data1), ncol (data2))
  CORPval <- matrix (NA, ncol (data1), ncol (data2))
  rownames (COR) <- rownames (CORPval) <- colnames (data1)
  colnames (COR) <- colnames (CORPval) <- colnames (data2)
  for (i in colnames (data1)){
    for (j in colnames (data2)){
      COR [i, j] <- cor (data1 [, i], data2 [, j])
      CORPval [i, j] <- cor.test (data1 [, i], data2 [, j])$p.value
    }
  }
  CorList <- list (Cor = COR, CorPval = CORPval)
  return (CorList)
}

for (ExpSum in c ( #"CellTypesPC1",
                   "CellTypesEigengene")){
  CellTypesSum <- get (ExpSum)
  CellTypeModuleAsso <- CorFun (CellTypesSum, mergedMEs)
  CellTypeModuleAssoPlot <- CellTypeModuleAsso$Cor %>%
    reshape2::melt () %>% 
    mutate (value = round (value, digits = 2)) %>%
    mutate (CorPval = paste0 (value, "(", CellTypeModuleAsso$CorPval %>%
                                reshape2::melt () %>% 
                                mutate (value = round (value, digits = 3)) %>%
                                .$value, ")"))
  CellTypeModuleAssoPlot <- CellTypeModuleAssoPlot [order (as.numeric (gsub ("M.", "", CellTypeModuleAssoPlot$Var2))), ] %>%
    mutate (Var2 = factor (Var2, levels = unique (Var2)))
  print (ggplot (CellTypeModuleAssoPlot, aes (x = Var2, y = Var1)) + 
           geom_tile (aes (fill = value)) + 
           scale_fill_gradientn (colours = c ("blue", "white", "red"),
                                 values = scales::rescale (c (-1, -0.5, 0, 0.5, 1))) +
           geom_text (aes (label = value), size = 3) +
           ggtitle (paste0 ("Cell type markers ", ifelse (ExpSum == "CellTypesPC1" , "PC1", "Eigengene"), " association with modules ME")) +
           labs (x = NULL, y = NULL, fill = "Correlation") +
           theme (axis.text = element_text (size = 16),
                  axis.text.x = element_text (angle = 90, hjust =  1, vjust = 0.5),
                  axis.title = element_text (size= 16, face = "bold")))
}


if (FALSE) {
CellTypesPC1 <- CellTypesPC1 %>% as.data.frame(as.is = T) %>%
  mutate (Muscle = factor (gsub ("_Sam.*|MD.._", "", rownames (CellTypesPC1)))) %>%
  mutate (individual = factor (gsub ("_.*", "", rownames (CellTypesPC1))))
 
CellTypesEigengene <- CellTypesEigengene %>% as.data.frame(as.is = T) %>%
  mutate (Muscle = factor (gsub ("_Sam.*|MD.._", "", rownames (CellTypesEigengene)))) %>%
  mutate (individual = factor (gsub ("_.*", "", rownames (CellTypesEigengene))))

mergedMEs <- mergedMEs %>% as.data.frame(as.is = T) %>%
  mutate (Muscle = factor (gsub ("_Sam.*|MD.._", "", rownames (mergedMEs)))) %>%
  mutate (individual = factor (gsub ("_.*", "", rownames (mergedMEs))))

# M.11 and LUM+ FAP Cells
p1 <- ggplot (CellTypesPC1, aes (Muscle, `LUM+ FAP Cells`, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "PC1") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("LUM+ FAP Cells")

p2 <- ggplot (CellTypesEigengene, aes (Muscle, `LUM+ FAP Cells`, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "Eigengene") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("LUM+ FAP Cells")

p3 <- ggplot (mergedMEs, aes (Muscle, M.11, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "ME") +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank()) +
  ggtitle ("M.11")

p4 <- ggplot (merge (mergedMEs [-c (33, 34)], CellTypesEigengene, by = "row.names"), aes (x = `LUM+ FAP Cells`, y = M.11, color = Muscle)) + 
  geom_point () + 
  scale_color_manual (values = MusColPlot) +
  theme_bw () +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank())
grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3), ggplotGrob (p4), size = "first")) 
rm (list = paste0 ("p", 1:4))

# M.11 and FBN1+ FAP Cells
p1 <- ggplot (CellTypesPC1, aes (Muscle, `FBN1+ FAP Cells`, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "PC1") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("FBN1+ FAP Cells")

p2 <- ggplot (mergedMEs, aes (Muscle, M.11, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "ME") +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank()) +
  ggtitle ("M.11")

p3 <- ggplot (merge (mergedMEs [-c (33, 34)], CellTypesPC1, by = "row.names"), aes (x = `FBN1+ FAP Cells`, y = M.11, color = Muscle)) + 
  geom_point () + 
  scale_color_manual (values = MusColPlot) +
  theme_bw () +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank())
grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3), size = "first")) 
rm (list = paste0 ("p", 1:3))

# M.11 and Tendon
p1 <- ggplot (CellTypesPC1, aes (Muscle, Tendon, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "PC1") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("Tendon")

p2 <- ggplot (mergedMEs, aes (Muscle, M.11, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "ME") +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank()) +
  ggtitle ("M.11")

p3 <- ggplot (merge (mergedMEs [-c (33, 34)], CellTypesPC1, by = "row.names"), aes (x = Tendon, y = M.11, color = Muscle)) + 
  geom_point () + 
  scale_color_manual (values = MusColPlot) +
  theme_bw () +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank())

grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3), size = "first")) 
rm (list = paste0 ("p", 1:3))

# M.31 and Type I
p1 <- ggplot (CellTypesPC1, aes (Muscle, `Type I`, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "PC1") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("Type I")

p2 <- ggplot (mergedMEs, aes (Muscle, M.31, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "ME") +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank()) +
  ggtitle ("M.31")

p3 <- ggplot (merge (mergedMEs [-c (33, 34)], CellTypesPC1, by = "row.names"), aes (x = `Type I`, y = M.31, color = Muscle)) + 
  geom_point () + 
  scale_color_manual (values = MusColPlot) +
  theme_bw () +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank())

grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3), size = "first")) 
rm (list = paste0 ("p", 1:3))

# M.19 and Type IIa
p1 <- ggplot (CellTypesPC1, aes (Muscle, `Type IIa`, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "PC1") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("Type IIa")

p2 <- ggplot (mergedMEs, aes (Muscle, M.19, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "ME") +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank()) +
  ggtitle ("M.19")

p3 <- ggplot (merge (mergedMEs [-c (33, 34)], CellTypesPC1, by = "row.names"), aes (x = `Type IIa`, y = M.19, color = Muscle)) + 
  geom_point () + 
  scale_color_manual (values = MusColPlot) +
  theme_bw () +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank())

grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3), size = "first")) 
rm (list = paste0 ("p", 1:3))

# M.23 and Type IIa
p1 <- ggplot (CellTypesPC1, aes (Muscle, `Type IIa`, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "PC1") +
  theme (axis.text = element_text(size = 12),
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
  axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5), panel.grid = element_blank(), 
  legend.title = element_blank()) +
  ggtitle ("Type IIa")

p2 <- ggplot (mergedMEs, aes (Muscle, M.23, fill = Muscle)) + 
  geom_boxplot (alpha = 0.5) + 
  scale_fill_manual (values = MusColPlot) +
  theme_bw () +
  labs (x = element_blank(), y = "ME") +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         legend.position = "none",
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank()) +
  ggtitle ("M.23")

p3 <- ggplot (merge (mergedMEs [-c (33, 34)], CellTypesPC1, by = "row.names"), aes (x = `Type IIa`, y = M.23, color = Muscle)) + 
  geom_point () + 
  scale_color_manual (values = MusColPlot) +
  theme_bw () +
  theme (axis.text = element_text(size = 12), 
         axis.title = element_text(size = 12, face = "bold"), 
         axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5),
         panel.grid = element_blank(), legend.title = element_blank())

grid.newpage ()
grid.draw (cbind (ggplotGrob (p1), ggplotGrob (p2), ggplotGrob (p3), size = "first")) 
rm (list = paste0 ("p", 1:3))}
```

### Module-trait association
```{r ModuleTrait, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 10}
# Sample information
phenWGCNA <- v_BatchMus$targets [, c (1, 5, 12)]

# Module eigengene (ME) vector
mergedMEs <- read.csv (filenames [grepl ("ModuleEigengenes", filenames)]) 
rownames (mergedMEs) <- colnames (v_BatchMus)
colnames (mergedMEs)[colnames (mergedMEs) != "MEgrey"] <- Module_rename$Rename [ match (gsub ("ME", "", colnames (mergedMEs)[colnames (mergedMEs) != "MEgrey"]), Module_rename$Module) ] 
colnames (mergedMEs)[colnames (mergedMEs) == "MEgrey"] = "grey"

# Gene modules
Module_sizes <- as.data.frame (table (GeneModules$mergedColors))

# Final table with sample informations and module eigengene 
complete_info <- merge (phenWGCNA, mergedMEs, by = "row.names") 
# complete_info <- complete_info %>% 
#   mutate(individual = as.factor (individual)) %>%
#   mutate(group = as.factor (group)) %>%
#   mutate(age = as.integer (age))

Module_list <- colnames (complete_info) [ grep ("M.", colnames (complete_info)) ]

# Considering muscle and age as fix effects in a single model (individuals were considered as random effect)
# Old:
# model1 = lme (Module_eigengene_vector ~ muscle + age, random=~1|individual, data, method = "REML")
# model2 = gls (Module_eigengene_vector ~ muscle + age, data, method = "REML")
# New:
# model = lmerTest::lmer (Module_eigengene_vector ~ muscle + (1|individual), data, REML = FALSE)
# anova (model) # Fixed effect 
# ranova (model) # Droping the random effect and test the model

ModuleTrait <- matrix (NA, nrow = length (Module_list), ncol = 2)
rownames (ModuleTrait) <- Module_list
colnames (ModuleTrait) <- c ("Muscle", "Individual")

for (module in Module_list) {
  fml <- as.formula (paste (noquote (module), "~ group + (1|individual)"))
  model <- lmerTest::lmer (fml, data = complete_info, REML = TRUE)
  ModuleTrait [module, ] <- c (anova (model)$`Pr(>F)`, ranova (model)$`Pr(>Chisq)`[2])
}

ModuleTraitAdj <- ModuleTrait
for (factor in colnames(ModuleTrait)){
  ModuleTraitAdj [ , factor] <- round (p.adjust (ModuleTrait [ , factor], method = "fdr"), 6)
}
ModuleTraitAdj <- as.data.frame (ModuleTraitAdj, as.is = T)
ModuleTraitAdj$Module <- paste0 (Module_sizes$Var1, " (", Module_sizes$Freq, ")") [match (noquote (rownames (ModuleTraitAdj)), Module_sizes$Var1)]

ModuleTraitAdjPlot <- reshape2::melt (ModuleTraitAdj)
ModuleTraitAdjPlot <- ModuleTraitAdjPlot [order (as.numeric (gsub ("M.| .*", "", ModuleTraitAdjPlot$Module))), ] %>% mutate (Module = factor (Module, levels = unique (Module)))

ggplot (ModuleTraitAdjPlot, aes (x = variable, y = Module)) + 
  geom_tile (aes (fill = value)) + 
  scale_fill_gradientn (colours = c ("white", "red", "black"),
                        values = scales::rescale (c (0, 0.05, 0.1, 0.5, 1))) +
  geom_text (aes (label = format (value, digits = 2))) +
  ggtitle ("Modules-factors association")  +
  labs (x = NULL, y = NULL, fill = "FDR") +
  theme (axis.text = element_text (size = 16),
         axis.title = element_text (size= 16, face = "bold"))
```

#### ME Plots
```{r ModuleTraitPlots1, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
filenames <- list.files (recursive = TRUE, path = "Outputs/WGCNA", pattern = paste0 (Candidate, ".csv"), full.names = TRUE)

# Sample information
phenWGCNA <- v_BatchMus$targets [, c (1, 5, 12)]

# Module eigengene (ME) vector
mergedMEs <- read.csv (filenames [grepl ("ModuleEigengenes", filenames)]) 
rownames (mergedMEs) <- colnames (v_BatchMus)
colnames (mergedMEs)[colnames (mergedMEs) != "MEgrey"] <- Module_rename$Rename [ match (gsub ("ME", "", colnames (mergedMEs)[colnames (mergedMEs) != "MEgrey"]), Module_rename$Module) ] 
colnames (mergedMEs)[colnames (mergedMEs) == "MEgrey"] = "grey"

# Gene modules
Module_sizes <- as.data.frame (table (GeneModules$mergedColors))

# Final table with sample informations and module eigengene 
complete_info <- merge (phenWGCNA, mergedMEs, by = "row.names") 

All_modules_to_plot <- reshape2::melt (complete_info [-c (1, 4)], id.vars = c ("group", "individual")) %>% 
  mutate (variable = paste0 (Module_sizes$Var1, " (", Module_sizes$Freq, ")") [match (noquote (variable), Module_sizes$Var1)]) %>%
  filter (variable != "grey (2772)") %>%
  mutate (variable = factor (variable, levels = unique (variable)))

for (module in sort (as.character (unique (All_modules_to_plot$variable)))) {
  p1 <- ggplot (All_modules_to_plot %>% filter (variable == module), aes (variable, value)) +
    geom_boxplot (aes (fill = group), alpha = 0.5) + 
    scale_fill_manual (values = col.muscle) + theme_bw () + 
    labs (x = element_blank(), y = "Module eigengene") +
    theme (axis.text = element_text (size = 12), axis.text.y = element_text (hjust = 1), 
           axis.title = element_text (size = 12, face = "bold"), 
           axis.ticks = element_blank (), plot.title = element_text (hjust = 0.5),
           panel.grid = element_blank(), legend.title = element_blank())
  # p1 + geom_dotplot (aes (group = group), fill = IndColPlot, binaxis = "y",
  #                   stackdir = "center", position = position_dodge (width = .8),
  #                   binwidth = 0.01, show.legend = FALSE) + 
  #   geom_hline (yintercept = 0, linetype = "dashed", color = "grey") 
  
  
  p2<- ggplot (All_modules_to_plot %>% filter (variable == module), aes (variable, value, fill = individual)) +
    geom_boxplot (alpha = 0.5) + 
    scale_fill_manual (values = col.individual) + theme_bw () + 
    labs (x = element_blank(), y = "Module eigengene") +
    theme (axis.text = element_text (size = 12), axis.text.y = element_text (hjust = 1), 
           axis.title = element_text (size = 12, face = "bold"), 
           axis.ticks = element_blank (), plot.title = element_text (hjust = 0.5),
           panel.grid = element_blank(), legend.title = element_blank())
  gridExtra::grid.arrange (cbind (ggplotGrob (p1), ggplotGrob (p2),
                           size = "first"))
}
```

#### MM and GS plots
```{r ModuleTraitPlots2, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
# Module Membership (MM) 
MM <- read.csv (filenames [grepl ("GeneModule_Membership", filenames)], row.names = 1, as.is = T, stringsAsFactors = F) 
KEEP <- colnames (MM) [grep ("^MM", colnames (MM))]
MM <- MM %>% select (KEEP)
colnames (MM)[colnames (MM) != "MMgrey"] <- Module_rename$Rename [ match (gsub ("MM", "", colnames (MM)[colnames (MM) != "MEgrey"]), Module_rename$Module) ] 
colnames (MM)[colnames (MM) == "MMgrey"] = "grey"

# Gene Significance (GS) 
GS_Muscle <- read.csv (filenames [grepl ("group_GeneTrait", filenames)], row.names = 1, as.is = T, stringsAsFactors = F) [1]

for (module in sort (as.character (unique (GeneModules$mergedColors)))) {
  GENES <- GeneModules %>% filter (mergedColors == module) %>% .$NAMES
  verboseScatterplot (MM [rownames (MM) %in% GENES, module],
                      GS_Muscle [rownames (GS_Muscle) %in% GENES, ],
                      main = module,
                      xlab = "Memebrship", ylab = "Gene Significance", abline = TRUE)
  
}
```

### Enrichment analysis
```{r EnrichmentAnalysis, message = FALSE, warning = FALSE}
rm (list = setdiff (ls (), c ("Data", "GeneModules", "v_BatchMus")))

GP_all_modules <- c ()
for (module in unique (GeneModules$mergedColors)) {
  Gene_list <- GeneModules %>% filter (mergedColors == module) %>% .$NAMES
  BG <- as.vector (GeneModules$NAMES)
  GP <- gprofiler2::gost (Gene_list, organism = 'hsapiens', evcodes = TRUE,
                          custom_bg = BG, correction_method = "fdr") 
  GP <- GP$result
  
  if (! is.null (GP) & module != "grey") {
    GP$Module <- module
    GP_all_modules [[module]] <- GP
  }
}
# The final table
GP_all_modules <- do.call (rbind, GP_all_modules)
GP_all_modules[c ("query", "significant", "precision", "recall")] <- NULL
GP_all_modules <- GP_all_modules %>% mutate (parents = sapply (parents , toString))
## Gene mapping
Gene_Symbols <- c ()
for (i in 1:nrow (GP_all_modules)) {
  ENS <- GP_all_modules [ i, "intersection" ]
  ENS <- unique (unlist (strsplit (as.character (ENS), split = ",")))
  Gene_Symbol <- c ()
  for (j in ENS) {
    Gene_Symbol [j] <- v_BatchMus$genes [v_BatchMus$genes$ensembl_gene_id == j, "hgnc_symbol"]
  }
Gene_Symbols [[i]] <- paste (Gene_Symbol, collapse = ",")
}
Gene_Symbols <- do.call (rbind, Gene_Symbols)
GP_all_modules <- cbind (GP_all_modules, Gene_Symbols)
write.csv (GP_all_modules, paste0 ("Outputs/WGCNA/Enrichment/EnrichmentResultsAllModules.csv"), row.names = F)
GP_Filtered_all_modules <- GP_all_modules %>% filter (intersection_size > 3) %>% filter (term_size < 2000) 
write.csv (GP_Filtered_all_modules, paste0 ("Outputs/WGCNA/Enrichment/EnrichmentResultsIntersect3AllModules.csv"), row.names = F)
save (GP_all_modules, GP_Filtered_all_modules, file = "Outputs/WGCNA/Enrichment/EnrichmentResultsAllModules.RData")
```

```{r}
sessionInfo()
```


