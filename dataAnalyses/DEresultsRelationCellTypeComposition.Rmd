---
title: "Human muscle transcriptomics (file 7)"
subtitle: 'DE genes relation with cell-type composition'
output:
  html_notebook: default
  word_document: default
editor_options:
  chunk_output_type: console
  always_allow_html: true
---

```{r setup5, include = FALSE, warning = FALSE, message = FALSE}
rm (list = ls ())
suppressPackageStartupMessages ({ 
  library (data.table)
  library (limma)
  library (edgeR)
  library (dplyr)
  library (WGCNA)
  library (biomaRt)
  library (flashClust)  
  library (ggplot2)
  library (scales) 
  library (dplyr)
  library (plotly)
  library (knitr)
  library (scales)
  library (cowplot)
  library (tidyr)
  library (grid)
  library (ggpubr)
  })
opts_chunk$set (eval = TRUE, echo = TRUE, tidy = TRUE, highlight = TRUE, dev = c ('png'), fig.width = 10, fig.height = 8,  fig.path = "figures/")

BiocStyle::markdown ()
options (scipen = 999)

# Loading the data
Data <- new.env(); load ("Outputs/BatchMusCorrectedAllData.RData", envir = Data )
D_BatchMus <- Data$D_BatchMus
v_BatchMus <- Data$v_BatchMus
load ("Outputs/CellTypeComposition/CellTypesGeneMarkersEigengene.RData")
```

### Correlation of genes with cell-type's eigengene vectors
```{r GeneCellTypesEigengeneCor, message = FALSE, warning = FALSE, echo = FALSE, fig.height = 10, fig.width = 6}
if (file.exists ("Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.RData")){
  load ("Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.RData")} else {
    # Calculation the correlation and the p-value
    GeneCellCor <- matrix (NA, nrow = nrow (v_BatchMus$E), ncol = ncol (CellTypesEigengene))
    colnames (GeneCellCor) <- colnames (CellTypesEigengene)
    rownames (GeneCellCor) <- rownames (v_BatchMus$E)
    GeneCellCorPval <- GeneCellCor 
    for (gene in rownames (v_BatchMus$E)){
      for (cell in colnames (CellTypesEigengene)){
        if (all (names (v_BatchMus$E [gene, ]) == names (CellTypesEigengene [, cell]))){
          GeneCellCor [gene, cell] <- cor (v_BatchMus$E [gene, ], CellTypesEigengene [, cell])
          GeneCellCorPval [gene, cell] <- cor.test (v_BatchMus$E [gene, ], CellTypesEigengene [, cell])$p.value
        }
      }
    }
    # Calculating the adjusted p-value
    GeneCellCorAdj <- GeneCellCorPval
    for (cell in colnames (GeneCellCorPval)){
      GeneCellCorAdj [, cell] <- round (p.adjust (GeneCellCorPval [, cell], method = "fdr"), 5)
    }
    GeneCellCorAdj <- as.data.frame (GeneCellCorAdj, as.is = T)
    GeneCellCor <- as.data.frame (GeneCellCor, as.is = T)
    
    # Subsetting the significant (FDR < 0.05) and moderate relationship (abs (cor) > 0.5)
    SigGenesCellTypes <- c()
    SigGenesCellTypesPos <- c()
    SigGenesCellTypesAll <- c()
    
    for (i in 1:ncol (GeneCellCorAdj)){
      AdjFilter <- rownames (GeneCellCorAdj [i] %>% filter (.[[1]] < 0.05))
      PosCorFilter <- rownames (GeneCellCor [i] %>% filter (.[[1]] >= 0.5))
      NegCorFilter <- rownames (GeneCellCor [i] %>% filter (.[[1]] <= -0.5))
      SigGenesCellTypes [[paste0 (colnames (GeneCellCorAdj)[i], " (PosCor)")]] <- intersect (AdjFilter, PosCorFilter)
      SigGenesCellTypes [[paste0 (colnames (GeneCellCorAdj)[i], " (NegCor)")]] <- intersect (AdjFilter, NegCorFilter)
      
      CorFilter <- rownames (GeneCellCor [i] %>% filter (abs (.[[1]]) >= 0.5))
      SigGenesCellTypesAll [[colnames (GeneCellCorAdj)[i]]] <- intersect (AdjFilter, CorFilter)
      SigGenesCellTypesPos [[colnames (GeneCellCorAdj)[i]]] <- intersect (AdjFilter, PosCorFilter)
    }
    kable (sapply (SigGenesCellTypes, length)) 
    kable (sapply (SigGenesCellTypesPos, length)) 
    kable (sapply (SigGenesCellTypesAll, length)) 
    # DE results and the relationship with cell type eigengene vector
    DEgenesVsCellGenes <- matrix (NA, nrow = length (ls (envir = Data, pattern = "OnlyIn")), ncol = ncol (CellTypesEigengene)+3)
    colnames (DEgenesVsCellGenes) <- c ("All", colnames (CellTypesEigengene), "NoAssoCellType", "PctNoAssoCellType")
    rownames (DEgenesVsCellGenes) <- gsub ("_.*", "", ls (envir = Data, pattern = "OnlyIn"))
    
    DEgenesNotRelatedToCellGenes <- c ()
    for (GeneList in ls (envir = Data, pattern = "OnlyIn")) {
      List <- get (GeneList, envir = Data)
      GeneList <- gsub ("_.*", "", GeneList)
      DEgenesVsCellGenes [GeneList, - 16] <-
        c (length (List), sapply (SigGenesCellTypesPos, function (cell)
          length (intersect (cell, List))),
          length (List) - length (intersect (unique (unlist (SigGenesCellTypesPos, use.names = F)), List)))
      DEgenesVsCellGenes [GeneList, 16] <- round (100*DEgenesVsCellGenes [GeneList, 15]/DEgenesVsCellGenes [GeneList, 1],
                                                  digits = 2)
      
      DEgenesNotRelatedToCellGenes [[GeneList]] <- setdiff (List, unique (unlist (SigGenesCellTypesPos)))
  }
    save (GeneCellCor, GeneCellCorPval, GeneCellCorAdj, DEgenesVsCellGenes, DEgenesNotRelatedToCellGenes, SigGenesCellTypes, file = "Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.RData")
  }

# Plotting the significant associations
GeneCellType <- data.frame (Gene = unique (unlist (SigGenesCellTypes, use.names = F)))
for (cell in colnames (GeneCellCor)) {
  CorData <- grep (gsub ("\\+", "\\." ,cell), names (SigGenesCellTypes), value = T, perl = F)
  GeneCellType$cell <- ifelse (GeneCellType$Gene %in% SigGenesCellTypes [[CorData[[1]]]], 1,
                               ifelse (GeneCellType$Gene %in% SigGenesCellTypes [[CorData[[2]]]], 2, 
                                       0))  
  colnames (GeneCellType)[colnames (GeneCellType) == "cell"] = cell
}

pheatmap::pheatmap (GeneCellType[, -1], color = c ("0" = "grey", "1" = "darkred", "2" = "darkblue"),
                      legend = F, show_rownames = F, treeheight_row = 0)


# All DE genes that are not related to cell-type
if (FALSE) {
load ("Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.RData")
CellTypeRelatedGenes <- unique (unlist (SigGenesCellTypesPos))
Data <- new.env(); load ("Outputs/BatchMusCorrectedAllData.RData", envir = Data )
DEnotCellTypeRelated <- c ()
DELFC1_notCellTypeRelated <- c ()

for (GeneList in ls (envir = Data, pattern = "HigherIn")) {
  List <- get (GeneList, envir = Data)
  GeneList <- gsub ("_.*", "", GeneList)
  COL <- paste0 ("Log2FC_", paste (sort (c (gsub (".*In|than.*", "", GeneList), gsub (".*than", "", GeneList))),
                collapse = "_"))
  DEnotCellTypeRelated [[GeneList]] <- setdiff (List, CellTypeRelatedGenes)
  LFC1 <- rownames (Data$DEtest_BatchMus) [abs (Data$DEtest_BatchMus[COL]) > 1]
  List <- List [List %in% LFC1]
  DELFC1_notCellTypeRelated [[GeneList]] <- setdiff (List, CellTypeRelatedGenes)
}

save (DEnotCellTypeRelated, DELFC1_notCellTypeRelated, file = "Outputs/CellTypeComposition/DEGeneNotRelatedToCellTypes.RData")
}
```

### Histogram
```{r, HistPlot, message = FALSE, warning = FALSE, echo = FALSE, fig.height = 10, fig.width = 10}
load ("Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.RData")

library (gridExtra)
pltList <- lapply (1:ncol (GeneCellCor), 
                   function (COL) qplot (unlist (GeneCellCor[, COL]), 
                             geom = "histogram", 
                             bins = 100,  
                             xlab = colnames (GeneCellCor)[COL], ylab = "Count",
                             xlim = c (-1, 1), ylim = c (0, 700)) + theme_bw ()+
                      geom_vline (xintercept = c (-0.5, 0.5), colour = "red"))
pltList <- do.call (grid.arrange, pltList)
ggsave (file = "Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.png", pltList, width = 10, height = 10)
```

![ ](Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.png)

```{r DEGeneCellTypes, message = FALSE, warning = FALSE, echo = FALSE, fig.height = 10, fig.width = 6}
kable (DEgenesVsCellGenes, align = "c")
```

### Enrichment analysis
```{r EnrichmentAnalysis, message = FALSE, warning = FALSE, echo = FALSE, fig.height = 10, fig.width = 6}
if (!file.exists ("Outputs/DE/EnrichmentResultsDEGenesNotRelatedToCellTypes.RData")) {
  rm (list = setdiff (ls (), c ("Data", "v_BatchMus")))
  load ("Outputs/CellTypeComposition/GeneCellTypesEigengeneCor.RData")
  DEEnrichment <- c ()
  for (GeneList in names (DEgenesNotRelatedToCellGenes)) {
    List <- DEgenesNotRelatedToCellGenes [[GeneList]]
    if (length (List) != 0) {
      GeneList <- gsub ("_.*", "", GeneList)
      BG <- as.vector (rownames (v_BatchMus))
      GP <- gprofiler2::gost (List, organism = 'hsapiens', evcodes = TRUE,
                              custom_bg = BG, correction_method = "fdr") 
      GP <- GP$result
      if (! is.null (GP)) {
        DEEnrichment [[GeneList]] <- GP
      }
    }
  }
  
  # The final table
  DEEnrichment <- do.call (rbind, DEEnrichment)
  DEEnrichment[c ("query", "significant", "precision", "recall")] <- NULL
  DEEnrichment <- DEEnrichment %>% tibble::rownames_to_column("List") %>% mutate (parents = sapply (parents , toString))
  
  ## Gene mapping
  Gene_Symbols <- c ()
  for (i in 1:nrow (DEEnrichment)) {
    ENS <- DEEnrichment [i, "intersection"]
    ENS <- unique (unlist (strsplit (as.character (ENS), split = ",")))
    Gene_Symbol <- c ()
    for (j in ENS) {
      Gene_Symbol [j] <- v_BatchMus$genes [v_BatchMus$genes$ensembl_gene_id == j, "hgnc_symbol"]
    }
    
    Gene_Symbols [[i]] <- paste (Gene_Symbol, collapse = ",")
  }
  
  Gene_Symbols <- do.call (rbind, Gene_Symbols)
  DEEnrichment <- cbind (DEEnrichment, Gene_Symbols)
  save (DEEnrichment, file = "Outputs/DE/EnrichmentResultsDEGenesNotRelatedToCellTypes.RData")
  
  DEEnrichment_Filtered <- DEEnrichment  %>% 
    filter (intersection_size > 3) %>% filter (term_size < 1000) %>%
    mutate (List = gsub ("\\..*", "", List)) %>% 
    mutate (evidence_codes = NULL)
  
  write.csv (DEEnrichment_Filtered, "Outputs/DE/EnrichmentResultsDEGenesNotRelatedToCellTypesIntersect3.csv", row.names = F)
}
```


